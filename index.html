<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Redividers Daily Word Challenge</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0; /* Reset margin for full control */
            line-height: 1.6;
            text-align: center;
            background-color: #f4f7f6;
            color: #333;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex; /* Use flexbox for main content centering */
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
        }

        /* --- Landing Page Specific Styles --- */
        #landingPage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 500px; /* Max width for content box */
            width: 90%; /* Responsive width */
            box-sizing: border-box; /* Include padding in width */
        }

        /* Styles for the logo on the landing page (larger) */
        #logo-landing {
            max-width: 250px; /* Updated size for landing page */
            height: auto;
            margin-right: 15px; /* Space between logo and title (if title were beside it) */
        }


        .landing-button-group {
            display: flex;
            flex-direction: column; /* Stack vertically on small screens */
            gap: 15px;
            width: 100%; /* Take full width of parent */
            align-items: center; /* Center buttons horizontally */
        }

        .landing-button {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.2s ease;
            text-decoration: none; /* Remove underline for links */
            min-width: 200px; /* Ensure buttons have a minimum width */
            text-align: center;
        }

        .landing-button:hover {
            transform: translateY(-2px);
        }

        .landing-button.purple { background-color: #8a2be2; } /* A vibrant purple */
        .landing-button.purple:hover { background-color: #6a1aab; }

        .landing-button.green { background-color: #28a745; }
        .landing-button.green:hover { background-color: #218838; }

        .landing-button.blue { background-color: #007bff; }
        .landing-button.blue:hover { background-color: #0056b3; }

        /* Instructions section on landing page */
        #game-instructions {
            width: 100%;
            margin-top: 10px; /* Half the distance from 20px */
            padding-top: 5px; /* Half the distance from 10px */
            border-top: 1px solid #e0e0e0;
            text-align: left;
        }
        #game-instructions h3 {
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #007bff;
        }
        #game-instructions ol {
            list-style-type: decimal;
            margin-left: 20px;
            margin-bottom: 20px;
        }
        #game-instructions li {
            margin-bottom: 10px;
        }
        #game-instructions .example-box {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        #game-instructions .example-box p {
            font-weight: normal; /* Reset font-weight from strong */
            margin-bottom: 0; /* Reset margin for paragraphs inside example */
            text-align: left;
        }
        #game-instructions .example-box p:first-of-type {
            font-weight: bold;
            margin-bottom: 10px;
        }
        #game-instructions .example-box span {
            font-weight: bold;
            border: 1px solid #888;
            padding: 2px 5px;
            border-radius: 4px;
        }


        /* --- Main Game Content (Initially Hidden) --- */
        #gameContent {
            display: none; /* Hidden by default, shown by JS */
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }

        #header {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
        }

        /* Styles for the logo on the game pages (smaller) */
        #logo-game {
            max-width: 130px;
            height: auto;
            margin-right: 15px;
        }

        #timer {
            font-weight: bold;
            font-size: 1.2em;
            color: #555;
            margin-top: 10px;
        }

        .question {
            display: none;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px 25px;
            margin: 20px auto;
            max-width: 600px;
            text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .question.active {
            display: block;
        }

        .question p {
            margin: 8px 0;
        }

        .question p strong {
            margin-right: 5px;
        }

        input[type="text"] {
            padding: 8px 10px;
            margin-left: 8px;
            font-size: 1em;
            border: 2px solid #ccc;
            border-radius: 5px;
            vertical-align: middle;
            box-sizing: border-box;
            transition: border-color 0.2s, background-color 0.2s;
        }

        input.medium {
            width: 150px;
            text-align: left;
        }

        input.small {
            width: 100px;
            text-align: left;
        }

        input:focus {
            border-color: #66afe9;
            outline: none;
        }

        button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .score-display-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            justify-content: center;
            margin: 5px auto 20px;
            max-width: 600px;
        }

        .top-row-buttons {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            width: 100%;
            z-index: 100;
            position: relative;
        }
        .main-action-row {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        #dailyResult {
            font-weight: bold;
            font-size: 1.1em;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
            color: #333;
            margin: 0;
        }

        input.correct {
            border-color: #28a745;
            background-color: #e6ffe6;
            color: #155724;
        }

        input.incorrect {
            border-color: #dc3545;
            background-color: #ffe6e6;
            color: #721c24;
        }

        .hint-btn {
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            vertical-align: middle;
            margin-bottom: 10px;
        }

        .hint-btn:hover {
            background-color: #5a6268;
        }

        .hint-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .hint-button-container {
            text-align: center;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #copyResultButton {
            padding: 10px 20px;
            font-size: 1em;
        }
        
        #copyResultDisplay {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
            min-height: 80px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-sizing: border-box;
            cursor: text;
            text-align: left;
        }

        #copyResultDisplay.show {
            opacity: 1;
            display: block;
        }


        /* --- Calendar Specific Styles --- */
        #calendarButton {
            background-color: #28a745;
            pointer-events: auto;
        }
        #calendarButton:hover {
            background-color: #218838;
        }

        /* Instructions button on game page specific styles */
        #instructionsButton {
            background-color: #8a2be2;
        }
        #instructionsButton:hover {
            background-color: #6a1aab;
        }


        #calendarContainer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        /* New class to make calendar visible */
        #calendarContainer.is-visible {
            display: flex;
        }


        .calendar-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header button {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #333;
            cursor: pointer;
            padding: 5px;
        }
        .calendar-header button:hover {
            color: #007bff;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-name, .calendar-day-cell {
            padding: 8px 5px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .calendar-day-name {
            background-color: #e9ecef;
            color: #555;
        }

        .calendar-day-cell {
            background-color: #f8f9fa;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .calendar-day-cell:hover {
            background-color: #e2e6ea;
        }

        .calendar-day-cell.empty {
            background-color: #f1f3f5;
            cursor: default;
        }

        .calendar-day-cell.today {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }

        .calendar-day-cell.solved {
            background-color: #28a745;
            color: white;
        }

        .calendar-day-cell.unsolved {
            background-color: #ffc107;
            color: #333;
        }

        .calendar-day-cell.selected-date {
            border: 2px solid #dc3545;
        }

        /* New style for unavailable past dates */
        .calendar-day-cell.unavailable-past {
            background-color: #e9ecef;
            color: #aaa;
            pointer-events: none;
        }

        .calendar-day-cell.no-question {
            background-color: #f1f3f5;
            color: #ccc;
            pointer-events: none;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div id="landingPage">
        <img id="logo-landing" src="https://i.imgur.com/KKd5PmI.png" alt="earap logo" />
        <h1 style="margin-top: 10px; font-size: 1.8em; color: #555;">Redividers Daily Word Challenge</h1>
        <div class="landing-button-group">
            <button id="landingCalendarBtn" class="landing-button green">Calendar</button>
            <button id="landingStartPuzzleBtn" class="landing-button purple">Go to Today's Puzzle!</button>
        </div>

        <div id="game-instructions" style="width: 100%; margin-top: 10px; padding-top: 5px; border-top: 1px solid #e0e0e0; text-align: left;">
            <h3 style="text-align: center; font-size: 1.5em; margin-bottom: 15px; color: #007bff;">How to Play:</h3>
            <ol style="list-style-type: decimal; margin-left: 20px; margin-bottom: 20px;">
                <li style="margin-bottom: 10px;">
                    Choose a single word for the first blank.
                </li>
                <li style="margin-bottom: 10px;">
                    Divide that word into two or more new words by adding spaces and type those into the remaining blank(s).
                </li>
            </ol>
            
            <div class="example-box">
                <p style="font-weight: bold; margin-bottom: 10px;">Here's an example:</p>
                <p style="margin-bottom: 5px;">My new wife has a young boy from her first marriage, so now I have a <span style="font-weight: bold; border: 1px solid #888; padding: 2px 5px; border-radius: 4px;">STEPSON</span>.</p>
                <p>He still forgets to tie his shoes, so sometimes he <span style="font-weight: bold; border: 1px solid #888; padding: 2px 5px; border-radius: 4px;">STEPS ON</span> his own laces.</p>
            </div>
        </div>
    </div>

    <div id="gameContent" style="display: none;">
        <div id="header">
            <img id="logo-game" src="https://i.imgur.com/KKd5PmI.png" alt="earap logo" />
        </div>

        <div class="score-display-wrapper">
            <div class="top-row-buttons">
                <button id="calendarButton" class="button">Calendar</button>
                <button id="instructionsButton" class="button">Instructions</button>
            </div>
            <p id="timer">Elapsed time: 0:00</p> 
            <div class="main-action-row">
                <button id="checkAnswerBtn">Check Answer</button>
                <p id="dailyResult"></p>
                <button id="copyResultButton" style="display:none;">Copy Result</button>
            </div>
            <textarea id="copyResultDisplay" readonly style="display:none;"></textarea>
        </div>

        <div id="questionsContainer"></div>
        
    </div> 

    <div id="calendarContainer">
        <div class="calendar-content">
            <div class="calendar-header">
                <button id="prevMonth">&lt;</button>
                <h3 id="currentMonthYear"></h3>
                <button id="nextMonth">&gt;</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-day-name">Sun</div>
                <div class="calendar-day-name">Mon</div>
                <div class="calendar-day-name">Tue</div>
                <div class="calendar-day-name">Wed</div>
                <div class="calendar-day-name">Thu</div>
                <div class="calendar-day-name">Fri</div>
                <div class="calendar-day-name">Sat</div>
            </div>
            <button id="closeCalendarBtn">Close</button>
        </div>
    </div>

    <script>
        // Define global constants and helper functions first
        const TODAY = new Date();
        TODAY.setHours(0, 0, 0, 0); // Normalize today's date to midnight

        // Helper to format date asYYYY-MM-DD
        const formatDate = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // Helper to get day difference
        const getDayDifference = (date1, date2) => {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            d1.setHours(0, 0, 0, 0);
            d2.setHours(0, 0, 0, 0);
            const diffTime = Math.abs(d2.getTime() - d1.getTime());
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        // Determine today's puzzle number based on the start date
        const CHALLENGE_START_DATE = new Date('2025-05-29T00:00:00'); // May 29, 2025

        // Fisher-Yates (Knuth) Shuffle for array randomization (moved to global scope)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Global variable for puzzle attempts
        let puzzleAttempts = {};

        // Load state from localStorage (moved to global scope for accessibility)
        const loadGameState = () => {
            const savedState = localStorage.getItem('redividersGameState');
            if (savedState) {
                const state = JSON.parse(savedState);
                puzzleAttempts = state.puzzleAttempts || {};
            }
        };

        // Save state to localStorage (moved to global scope for accessibility)
        const saveGameState = () => {
            const state = {
                puzzleAttempts: puzzleAttempts,
            };
            localStorage.setItem('redividersGameState', JSON.stringify(state));
        };

        document.addEventListener('DOMContentLoaded', () => {
            console.log('--- Script started and DOM loaded ---');
            console.log('--- Version: Final Attempt (with aggressive localStorage.clear()) ---');


            // --- CANVAS-SPECIFIC FIX: Clear localStorage for a clean run in the emulator ---
            // REMOVE THIS LINE WHEN DEPLOYING TO A LIVE WEBSITE!
            localStorage.clear(); // More aggressive clear than removeItem
            // --------------------------------------------------------------------------------

            // --- Get references to new landing page elements ---
            const landingPage = document.getElementById('landingPage');
            const gameContent = document.getElementById('gameContent');
            const landingStartPuzzleBtn = document.getElementById('landingStartPuzzleBtn');
            const landingCalendarBtn = document.getElementById('landingCalendarBtn');

            // --- Your Existing Game Elements ---
            const questionsContainer = document.getElementById('questionsContainer'); // New container for dynamic questions
            const checkAnswerBtn = document.getElementById('checkAnswerBtn');
            const dailyResult = document.getElementById('dailyResult');
            const copyResultButton = document.getElementById('copyResultButton');
            const copyResultDisplay = document.getElementById('copyResultDisplay');
            const timerDisplay = document.getElementById('timer'); // Corrected this line
            const calendarButton = document.getElementById('calendarButton'); // On game page
            const calendarContainer = document.getElementById('calendarContainer'); // Calendar modal
            const currentMonthYear = document.getElementById('currentMonthYear');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            const instructionsButton = document.getElementById('instructionsButton'); // Re-added instructions button on game page

            // --- New Close Buttons for Modals ---
            const closeCalendarBtn = document.getElementById('closeCalendarBtn');

            // State to track where the calendar was opened from
            let openedFromPage = 'landingPage'; // Default to landing page

            // --- CENTRALIZED QUESTION DATA ---
            const questionsData = [
                {
                    id: 'question1',
                    text: 'Susan hadn\'t slept since her neighbor\'s favorite CD started playing at 3 AM. She had a presentation to give that morning at work, and though her husband tried to reassure her, she was BLANK1. "Why," she wondered angrily, "had he put his BLANK2?!"',
                    blanks: [
                        { id: 'answer1', size: 'medium', correct: ['disconsolate'], hintSource: 'disconsolate' },
                        { id: 'answer2', size: 'medium', correct: ['disk on so late'] }
                    ]
                },
                {
                    id: 'question2',
                    text: 'Even a Supreme Court BLANK1 needs an occasional break. Sotomayor takes her tea without lemon or sugar; she has it with BLANK2.',
                    blanks: [
                        { id: 'answer3', size: 'medium', correct: ['justice'], hintSource: 'justice' },
                        { id: 'answer4', size: 'medium', correct: ['just ice'] }
                    ]
                },
                {
                    id: 'question3',
                    text: 'My dog couldn\'t control his bladder in the house and peed on my BLANK1. Now he stays in my automobile. He\'s a BLANK2.',
                    blanks: [
                        { id: 'answer5', size: 'medium', correct: ['carpet'], hintSource: 'carpet' },
                        { id: 'answer6', size: 'medium', correct: ['car pet'] }
                    ]
                },
                {
                    id: 'question4',
                    text: 'Jennifer was suspicious of the police officers huddled BLANK1. She was sure they were out BLANK2.',
                    blanks: [
                        { id: 'answer7', size: 'medium', correct: ['together'], hintSource: 'together' },
                        { id: 'answer8', size: 'medium', correct: ['to get her', 'together'] }
                    ]
                },
                {
                    id: 'question5',
                    text: 'It took hours, but Tom finally shaved off his beard and BLANK1. I really think his arm BLANK2 from all the effort.',
                    blanks: [
                        { id: 'answer9', size: 'medium', correct: ['mustache'], hintSource: 'mustache' },
                        { id: 'answer10', size: 'medium', correct: ['must ache'] }
                    ]
                },
                {
                    id: 'question6',
                    text: 'In Paris I visited the National BLANK1. And then the Triumphal BLANK2. BLANK3 never seen anything so impressive.',
                    blanks: [
                        { id: 'answer11', size: 'medium', correct: ['archive'], hintSource: 'archive' },
                        { id: 'answer12', size: 'small', correct: ['arch'] },
                        { id: 'answer13', size: 'small', correct: ['ive'] }
                    ]
                },
                {
                    id: 'question7',
                    text: 'You shouldn\'t sit around and let your muscles BLANK1. You\'d better train for the marathon if you want to win BLANK2.',
                    blanks: [
                        { id: 'answer14', size: 'medium', correct: ['atrophy'], hintSource: 'atrophy' },
                        { id: 'answer15', size: 'medium', correct: ['a trophy', 'atrophy'] }
                    ]
                },
                {
                    id: 'question8',
                    text: 'Wearing her crown adorned with oval and BLANK1 sapphires, the listless queen felt undecided. Should she go to the banquet BLANK2?',
                    blanks: [
                        { id: 'answer16', size: 'medium', correct: ['orbed'], hintSource: 'orbed' },
                        { id: 'answer17', size: 'medium', correct: ['or bed'] }
                    ]
                },
                {
                    id: 'question9',
                    text: 'The clumsy chemist BLANK1 and spilled the slimy serum on the floor. Overnight, this BLANK2 a swarm of ants that then gained superpowers.',
                    blanks: [
                        { id: 'answer18', size: 'medium', correct: ['goofed'], hintSource: 'goofed' },
                        { id: 'answer19', size: 'medium', correct: ['goo fed'] }
                    ]
                },
                {
                    id: 'question10',
                    text: 'The old deer was exhausted and his legs nearly BLANK1. Still, the BLANK2 his herd through the dense forest to safety.',
                    blanks: [
                        { id: 'answer20', size: 'medium', correct: ['buckled'], hintSource: 'buckled' },
                        { id: 'answer21', size: 'medium', correct: ['buck led', 'buckled'] }
                    ]
                },
                {
                    id: 'question11',
                    text: 'With acid and a metal plate, she’s an BLANK1 like no other. She can do lettering, illustrations, patterns, BLANK2. BLANK3 talents are truly limitless.',
                    blanks: [
                        { id: 'answer22', size: 'medium', correct: ['etcher'], hintSource: 'etcher' },
                        { id: 'answer23', size: 'small', correct: ['etc'] },
                        { id: 'answer24', size: 'small', correct: ['her'] }
                    ]
                },
                {
                    id: 'question12',
                    text: 'My BLANK1 other insists on a prenup before marriage. I don’t agree, but I’ll BLANK2 change her mind.',
                    blanks: [
                        { id: 'answer25', size: 'medium', correct: ['significant'], hintSource: 'significant' },
                        { id: 'answer26', size: 'medium', correct: ['sign if i can\'t'] }
                    ]
                },
                {
                    id: 'question13',
                    text: 'Rocco grew up in a rundown part of Chicago where BLANK1 forced him to fight for what little was available. So you want to know about his facial BLANK2? BLANK3 life takes its toll!',
                    blanks: [
                        { id: 'answer27', size: 'medium', correct: ['scarcity'], hintSource: 'scarcity' },
                        { id: 'answer28', size: 'small', correct: ['scar'] },
                        { id: 'answer29', size: 'small', correct: ['city'] }
                    ]
                },
                {
                    id: 'question14',
                    text: 'I stopped watching Game of Thrones. You\'ve seen one BLANK1, you\'ve seen them all. After a few episodes the series seemed to BLANK2.',
                    blanks: [
                        { id: 'answer30', size: 'medium', correct: ['dragon'], hintSource: 'dragon' },
                        { id: 'answer31', size: 'medium', correct: ['drag on', 'dragon'] }
                    ]
                },
                {
                    id: 'question15',
                    text: 'You say you’re fed up, that I\'ve been BLANK1 to prove my feelings since our freshman year? You\'ll see when at the BLANK2 you a love ballad.',
                    blanks: [
                        { id: 'answer32', size: 'medium', correct: ['promising'], hintSource: 'promising' },
                        { id: 'answer33', size: 'medium', correct: ['prom i sing', 'promising'] }
                    ]
                },
                {
                    id: 'question16',
                    text: 'The queen can’t stop BLANK1 about how her husband has changed for the better. The newly BLANK2 is the picture of health.',
                    blanks: [
                        { id: 'answer34', size: 'medium', correct: ['thinking'], hintSource: 'thinking' },
                        { id: 'answer35', size: 'medium', correct: ['thin king', 'thinking'] }
                    ]
                },
                {
                    id: 'question17',
                    text: 'The picnic was going great, with me winning 21-16 at BLANK1. But when it came time to eat, with one taste I knew I\'d put BLANK2 the lamb.',
                    blanks: [
                        { id: 'answer36', size: 'medium', correct: ['badminton'], hintSource: 'badminton' },
                        { id: 'answer37', size: 'medium', correct: ['bad mint on', 'badminton'] }
                    ]
                },
                {
                    id: 'question18',
                    text: 'Our pet Misty seems depressed and even BLANK1, staring blankly at the wall for hours. We need to give that BLANK2 for her nerves.',
                    blanks: [
                        { id: 'answer38', size: 'medium', correct: ['catatonic'], hintSource: 'catatonic' },
                        { id: 'answer39', size: 'medium', correct: ['cat a tonic', 'catatonic'] }
                    ]
                },
                {
                    id: 'question19',
                    text: 'I stayed with my mother\'s older brother, and he was appalled at how BLANK1 I left the room. I felt terrible and gave my BLANK2 apology.',
                    blanks: [
                        { id: 'answer40', size: 'medium', correct: ['unclean'], hintSource: 'unclean' },
                        { id: 'answer41', size: 'medium', correct: ['uncle an', 'unclean'] }
                    ]
                },
                {
                    id: 'question20',
                    text: 'What you don’t do to help endangered animals may doom them like the BLANK1 bird. What you BLANK2 can ensure their survival for years to come.',
                    blanks: [
                        { id: 'answer42', size: 'medium', correct: ['dodo'], hintSource: 'dodo' },
                        { id: 'answer43', size: 'medium', correct: ['do do', 'dodo'] }
                    ]
                },
                {
                    id: 'question21',
                    text: 'The stylist took one look at Henry\'s brittle nails, and asked if he\'d like to add keratin treatments to his BLANK1. She added, "I assure you, every BLANK2 of this condition says it\'s well worth the cost!"',
                    blanks: [
                        { id: 'answer44', size: 'medium', correct: ['manicure'], hintSource: 'manicure' },
                        { id: 'answer45', size: 'medium', correct: ['man i cure', 'manicure'] }
                    ]
                },
                {
                    id: 'question22',
                    text: 'Dangerously, the tiny boat began to BLANK1 in the storm. Engine problems arose as the wrong BLANK2 on the fuel tank let in seawater.',
                    blanks: [
                        { id: 'answer46', size: 'medium', correct: ['capsize'], hintSource: 'capsize' },
                        { id: 'answer47', size: 'medium', correct: ['cap size', 'capsize'] }
                    ]
                },
                {
                    id: 'question23',
                    text: 'Janet favors aggressive investments in untested ventures; BLANK1, her partner rarely shies away from risk. On the other hand, their clients BLANK2 choices that offer slow but steady growth.',
                    blanks: [
                        { id: 'answer48', size: 'medium', correct: ['likewise'], hintSource: 'likewise' },
                        { id: 'answer49', size: 'medium', correct: ['like wise', 'likewise'] }
                    ]
                },
                {
                    id: 'question24',
                    text: 'After my recent BLANK1 of my parents\' vinyl in the attic, I find the 70s folk songs rather boring. Still, I find BLANK2 fun to dance to.',
                    blanks: [
                        { id: 'answer50', size: 'medium', correct: ['discovery'], hintSource: 'discovery' },
                        { id: 'answer51', size: 'medium', correct: ['disco very', 'discovery'] }
                    ]
                },
                {
                    id: 'question25',
                    text: 'He warned his friend about the charming BLANK1 who seemed too good to be true. He even pointed to the stray, synthetic BLANK2 lying on the floor, likely from her extensions.',
                    blanks: [
                        { id: 'answer52', size: 'medium', correct: ['temptress'], hintSource: 'temptress' },
                        { id: 'answer53', size: 'medium', correct: ['temp tress', 'temptress'] }
                    ]
                },
                {
                    id: 'question26',
                    text: 'We watched as trucks slowly rumbled past us with their hazardous BLANK1, escorted by police vehicles. An officer finally waved us forward and let our BLANK2 through the intersection.',
                    blanks: [
                        { id: 'answer54', size: 'medium', correct: ['cargo'], hintSource: 'cargo' },
                        { id: 'answer55', size: 'medium', correct: ['car go', 'cargo'] }
                    ]
                },
                {
                    id: 'question27',
                    text: 'Volunteers at the festival sold souvenirs to raise money for BLANK1 protection in Florida. Our job was to BLANK2 shirt booth.',
                    blanks: [
                        { id: 'answer56', size: 'medium', correct: ['manatee'], hintSource: 'manatee' },
                        { id: 'answer57', size: 'medium', correct: ['man a tee', 'manatee'] }
                    ]
                },
                {
                    id: 'question28',
                    text: 'The landlord ousted his BLANK1, who turned out to be an amateur entomologist. Around the apartment were 35 terrariums of beetles, spiders, you name it, including BLANK2 farms.',
                    blanks: [
                        { id: 'answer58', size: 'medium', correct: ['tenant'], hintSource: 'tenant' },
                        { id: 'answer59', size: 'medium', correct: ['ten ant', 'tenant'] }
                    ]
                },
                {
                    id: 'question29',
                    text: 'Giuseppe crafts each sandwich with BLANK1 care and patience. Some customers at his BLANK2 him for his slow service, but he believes quality can’t be rushed.',
                    blanks: [
                        { id: 'answer60', size: 'medium', correct: ['deliberate'], hintSource: 'deliberate' },
                        { id: 'answer61', size: 'medium', correct: ['deli berate', 'deliberate'] }
                    ]
                },
                {
                    id: 'question30',
                    text: 'Australian English differs from American English in its BLANK1 features, such as the rising pitch at the ends of statements. I’d like to do further research BLANK2 accents, such as those of Canadian and Haitian French.',
                    blanks: [
                        { id: 'answer62', size: 'medium', correct: ['intonational'], hintSource: 'intonational' },
                        { id: 'answer63', size: 'medium', correct: ['into national', 'intonational'] }
                    ]
                },
                {
                    id: 'question31',
                    text: 'Lenny is about the BLANK1 person I know; he\'s downright cruel. For my birthday, he gift-wrapped and gave BLANK2 of hornets.',
                    blanks: [
                        { id: 'answer64', size: 'medium', correct: ['meanest'], hintSource: 'meanest' },
                        { id: 'answer65', size: 'medium', correct: ['me a nest', 'meanest'] }
                    ]
                },
                {
                    id: 'question32',
                    text: 'We offer various BLANK1 for yoga practice, such as group sessions or private lessons. We also offer discounts BLANK2 purchased along with class packages.',
                    blanks: [
                        { id: 'answer66', size: 'medium', correct: ['formats'], hintSource: 'formats' },
                        { id: 'answer67', size: 'medium', correct: ['for mats', 'formats'] }
                    ]
                },
                {
                    id: 'question33',
                    text: 'There\'s no BLANK1 in their advertising; the pigs really do eat top-quality grub off nice plates. And after each meal, the farmhands wash every BLANK2 at a time with care.',
                    blanks: [
                        { id: 'answer68', size: 'medium', correct: ['dishonesty'], hintSource: 'dishonesty' },
                        { id: 'answer69', size: 'medium', correct: ['dish one sty', 'dishonesty'] }
                    ]
                },
                {
                    id: 'question34',
                    text: 'After the warehouse workers voted to strike, the board members speculated BLANK1 whether one young staff member, a summer hire in the HR department, was to blame. Did this BLANK2 with the union, sharing confidential data that fueled their outrage?',
                    blanks: [
                        { id: 'answer70', size: 'medium', correct: ['internally'], hintSource: 'internally' },
                        { id: 'answer71', size: 'medium', correct: ['intern ally', 'internally'] }
                    ]
                },
                {
                    id: 'question35',
                    text: 'Her fiancé had schemed to BLANK1 everything he claimed to be. So the woman holding the white, shimmery BLANK2 the last piece of her wedding cake, before tossing the dress into the fire.',
                    blanks: [
                        { id: 'answer72', size: 'medium', correct: ['fabricate'], hintSource: 'fabricate' },
                        { id: 'answer73', size: 'medium', correct: ['fabric ate', 'fabricate'] }
                    ]
                },
                {
                    id: 'question36',
                    text: 'The strict parents made their BLANK1 quite clear: education was the priority, not romantic relationships. That\'s why they wouldn\'t let the young BLANK2 their daughter until she had graduated.',
                    blanks: [
                        { id: 'answer74', size: 'medium', correct: ['mandate'], hintSource: 'mandate' },
                        { id: 'answer75', size: 'medium', correct: ['man date', 'mandate'] }
                    ]
                },
                {
                    id: 'question37',
                    text: 'The young campers planned to visit the local park and BLANK1 for wild mushrooms. But first they had to present their IDs to the ranger BLANK2 verification.',
                    blanks: [
                        { id: 'answer76', size: 'medium', correct: ['forage'], hintSource: 'forage' },
                        { id: 'answer77', size: 'medium', correct: ['for age', 'forage'] }
                    ]
                },
                {
                    id: 'question38',
                    text: 'The general store sold BLANK1 items, from fishing lures to homemade jams. On summer days, a batch of freshly picked herbs would BLANK2 on racks outside.',
                    blanks: [
                        { id: 'answer78', size: 'medium', correct: ['sundry'], hintSource: 'sundry' },
                        { id: 'answer79', size: 'medium', correct: ['sun dry', 'sundry'] }
                    ]
                },
                {
                    id: 'question39',
                    text: 'The low-flying BLANK1 from the nearby military base caused the ground to shake and buildings to rattle. It got so bad it would crack plaster walls in homes and even BLANK2 at the bowling alley.',
                    blanks: [
                        { id: 'answer80', size: 'medium', correct: ['warplanes'], hintSource: 'warplanes' },
                        { id: 'answer81', size: 'medium', correct: ['warp lanes', 'warplanes'] }
                    ]
                },
                {
                    id: 'question40',
                    text: 'The guests at the gallery politely nibbled on delicate BLANK1, a selection of toasted bread, caviar and smoked salmon, as they admired the artwork. It was a chaotic blob of paint on a canvas, like it had been flung by a chimpanzee, and I wondered, BLANK2 be taught to create art?',
                    blanks: [
                        { id: 'answer82', size: 'medium', correct: ['canapes'], hintSource: 'canapes' },
                        { id: 'answer83', size: 'medium', correct: ['can apes', 'canapes'] }
                    ]
                },
                {
                    id: 'question41',
                    text: 'Look, I want to be BLANK1 with you because you\'re fooling yourself. You\'ve really got to get tutored if you\'re going to pass this math exam. It\'s not enough to say you\'ll do to the best of your abilities. Doing what you BLANK2 not help the last time around.',
                    blanks: [
                        { id: 'answer84', size: 'medium', correct: ['frank'], hintSource: 'frank' },
                        { id: 'answer85', size: 'medium', correct: ['franken'] } // Assuming 'frank enough' was intended, or 'frank and' could be split. Adding a new, different split.
                    ]
                },
                {
                    id: 'question42',
                    text: 'Here is a dummy BLANK1 to add new questions. This BLANK2 will make it easy.',
                    blanks: [
                        { id: 'answer86', size: 'medium', correct: ['question'], hintSource: 'question' },
                        { id: 'answer87', size: 'medium', correct: ['temp late', 'template'] }
                    ]
                }
            ];

            const getPuzzleNumberForDate = (date) => {
                const diffDays = getDayDifference(CHALLENGE_START_DATE, date);
                return diffDays; // Use diffDays directly for 0-indexed array
            };

            const todayPuzzleIndex = getPuzzleNumberForDate(TODAY); // 0-indexed
            const LAST_QUESTION_DATE = new Date(CHALLENGE_START_DATE);
            LAST_QUESTION_DATE.setDate(CHALLENGE_START_DATE.getDate() + (questionsData.length - 1));
            LAST_QUESTION_DATE.setHours(0,0,0,0); // Normalize to midnight

            let currentPuzzleIndex = todayPuzzleIndex; // Start with today's puzzle
            let puzzleStartTime;
            let timerInterval;
            let selectedCalendarDate = null; // Stores the date selected from the calendar

            // --- Dynamic Question Rendering Function ---
            const renderCurrentQuestion = (puzzleIdx) => {
                questionsContainer.innerHTML = ''; // Clear previous question

                const questionData = questionsData[puzzleIdx];
                if (!questionData) {
                    console.warn(`Question data for index ${puzzleIdx} not found. Displaying landing page.`);
                    gameContent.style.display = 'none';
                    landingPage.style.display = 'flex';
                    stopTimer();
                    return;
                }

                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question', 'active');
                questionDiv.id = questionData.id;

                const hintButtonContainer = document.createElement('div');
                hintButtonContainer.classList.add('hint-button-container');

                const hintButton = document.createElement('button');
                hintButton.classList.add('hint-btn');
                hintButton.textContent = 'Hint';
                hintButton.dataset.questionNum = puzzleIdx + 1; // Use 1-indexed for display
                hintButton.dataset.blankIndex = 0; // Hint always for the first blank
                hintButtonContainer.appendChild(hintButton);

                const hintDisplaySpan = document.createElement('span');
                hintDisplaySpan.classList.add('hint-display');
                hintDisplaySpan.dataset.questionNum = puzzleIdx + 1;
                hintDisplaySpan.dataset.blankIndex = 0;
                hintButtonContainer.appendChild(hintDisplaySpan);

                questionDiv.appendChild(hintButtonContainer);

                let questionHtml = questionData.text;
                questionData.blanks.forEach((blank, index) => {
                    const inputHtml = `<input type="text" id="${blank.id}" placeholder="Answer" class="${blank.size}" data-question-index="${puzzleIdx}" data-blank-index="${index}">`;
                    questionHtml = questionHtml.replace(`BLANK${index + 1}`, inputHtml);
                });

                const p = document.createElement('p');
                p.innerHTML = `<strong>${puzzleIdx + 1}.</strong> ${questionHtml}`; // Use 1-indexed for display
                questionDiv.appendChild(p);

                questionsContainer.appendChild(questionDiv);

                // Attach event listener for hints
                hintButton.addEventListener('click', handleHintClick);

                // Attach input event listeners for real-time saving
                questionDiv.querySelectorAll('input[type="text"]').forEach(input => {
                    input.addEventListener('input', handleInputChange);
                });

                // Trigger UI update
                const currentPuzzleDate = selectedCalendarDate || new Date(CHALLENGE_START_DATE.getTime() + puzzleIdx * (1000 * 60 * 60 * 24));
                const currentPuzzleDateFormatted = formatDate(currentPuzzleDate);
                selectedCalendarDate = currentPuzzleDate; // Ensure selected date is correctly set

                // Call updateCheckButtonState here after question is rendered and selectedCalendarDate is set
                // Also ensures answers and hint progress are loaded into the newly created inputs/spans
                updateCheckButtonState();
            };

            // --- Event Handlers (Modified to use questionsData) ---

            const handleInputChange = (event) => {
                const input = event.target;
                const puzzleIdx = parseInt(input.dataset.questionIndex);
                const questionId = questionsData[puzzleIdx].id; // Get the question ID for saving
                const currentPuzzleDate = new Date(CHALLENGE_START_DATE.getTime() + puzzleIdx * (1000 * 60 * 60 * 24));
                const currentPuzzleDateFormatted = formatDate(currentPuzzleDate);

                if (!puzzleAttempts[currentPuzzleDateFormatted]) {
                    puzzleAttempts[currentPuzzleDateFormatted] = { answers: {}, results: {}, hintsData: {}, score: '0/0', completed: false, timeTaken: 0, startTime: null };
                }
                puzzleAttempts[currentPuzzleDateFormatted].answers[input.id] = input.value.trim();
                saveGameState();
            };

            const handleHintClick = (event) => {
                const hintButton = event.target;
                const questionNumDisplay = parseInt(hintButton.dataset.questionNum); // 1-indexed
                const puzzleIdx = questionNumDisplay - 1; // 0-indexed for array access
                
                const questionData = questionsData[puzzleIdx];
                const hintSource = questionData.blanks[0].hintSource; // Hint source is from the first blank's hintSource property

                const hintDisplaySpan = document.querySelector(`.hint-display[data-question-num="${questionNumDisplay}"][data-blank-index="0"]`);
                const firstInputBox = document.getElementById(questionData.blanks[0].id);

                if (!hintSource || !hintDisplaySpan || !firstInputBox) return;

                const currentPuzzleDate = new Date(CHALLENGE_START_DATE.getTime() + puzzleIdx * (1000 * 60 * 60 * 24));
                const currentPuzzleDateFormatted = formatDate(currentPuzzleDate);

                if (!puzzleAttempts[currentPuzzleDateFormatted]) {
                    puzzleAttempts[currentPuzzleDateFormatted] = {
                        answers: {}, results: {}, hintsData: {}, score: '0/0', completed: false, timeTaken: 0, startTime: null
                    };
                }
                const currentPuzzleData = puzzleAttempts[currentPuzzleDateFormatted];

                if (!currentPuzzleData.hintsData[questionNumDisplay] || !currentPuzzleData.hintsData[questionNumDisplay].shuffledIndices || currentPuzzleData.hintsData[questionNumDisplay].shuffledIndices.length === 0) {
                    const nonSpaceIndices = [];
                    for(let i = 0; i < hintSource.length; i++) {
                        if (hintSource[i] !== ' ') {
                            nonSpaceIndices.push(i);
                        }
                    }
                    currentPuzzleData.hintsData[questionNumDisplay] = {
                        shuffledIndices: shuffleArray(nonSpaceIndices),
                        nextIndexToReveal: 0
                    };
                    saveGameState();
                }
                const hintData = currentPuzzleData.hintsData[questionNumDisplay];

                let revealedCount = hintData.nextIndexToReveal;

                if (revealedCount < hintSource.replace(/\s/g, '').length) {
                    revealedCount++;
                    hintData.nextIndexToReveal = revealedCount;
                    currentPuzzleData.hintsData[questionNumDisplay] = hintData;
                    saveGameState();

                    let displayedHintArray = Array(hintSource.length).fill('_');
                    for (let i = 0; i < hintSource.length; i++) {
                        if (hintSource[i] === ' ') {
                            displayedHintArray[i] = ' ';
                        }
                    }

                    for (let i = 0; i < revealedCount; i++) {
                        const originalIndex = hintData.shuffledIndices[i];
                        if (originalIndex !== undefined && originalIndex < hintSource.length) {
                             displayedHintArray[originalIndex] = hintSource[originalIndex].toUpperCase();
                        }
                    }
                    hintDisplaySpan.textContent = displayedHintArray.join('');

                    if (revealedCount >= hintSource.replace(/\s/g, '').length) {
                        hintButton.disabled = true;
                        firstInputBox.value = hintSource.toUpperCase();
                    }
                } else {
                    hintButton.disabled = true;
                }
                updateCheckButtonState();
            };

            const updateCheckButtonState = () => {
                const activeQuestion = document.querySelector('.question.active');
                if (!activeQuestion) {
                    checkAnswerBtn.disabled = true;
                    return;
                }

                const currentPuzzleDate = selectedCalendarDate || TODAY;
                const currentPuzzleDateFormatted = formatDate(currentPuzzleDate);
                const puzzleData = puzzleAttempts[currentPuzzleDateFormatted];
                const puzzleIdx = questionsData.findIndex(q => q.id === activeQuestion.id); // Get 0-indexed puzzle index

                if (puzzleData && puzzleData.completed) {
                    disableInputsAndButtons(true);
                    const hintsUsedCount = (puzzleData.hintsData[puzzleIdx + 1] && puzzleData.hintsData[puzzleIdx + 1].nextIndexToReveal) || 0; // Use 1-indexed key
                    dailyResult.innerHTML = `<strong>Correct: ${puzzleData.score}</strong>, Hints: ${hintsUsedCount}, <strong>Time used: ${formatTime(puzzleData.timeTaken)}</strong>`;
                    copyResultButton.style.display = 'inline-block';
                } else {
                    disableInputsAndButtons(false);
                    checkAnswerBtn.disabled = false;
                    copyResultButton.style.display = 'none';
                    const hintsUsedCount = (puzzleData && puzzleData.hintsData[puzzleIdx + 1] && puzzleData.hintsData[puzzleIdx + 1].nextIndexToReveal) || 0;
                    const currentElapsedTime = puzzleStartTime ? Math.floor((new Date() - puzzleStartTime) / 1000) : 0;
                    dailyResult.innerHTML = `<strong>Correct: ${puzzleData ? puzzleData.score : '0/0'}</strong>, Hints: ${hintsUsedCount}, <strong>Time used: ${formatTime(currentElapsedTime)}</strong>`;
                }
                renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
            };

            // Timer functions
            const startTimer = () => {
                if (timerInterval) clearInterval(timerInterval); // Clear existing interval

                const currentPuzzleDateFormatted = formatDate(selectedCalendarDate || TODAY);
                if (!puzzleAttempts[currentPuzzleDateFormatted]) {
                    puzzleAttempts[currentPuzzleDateFormatted] = {
                        answers: {},
                        results: {},
                        hintsData: {},
                        score: '0/0',
                        completed: false,
                        timeTaken: 0,
                        startTime: null
                    };
                }

                if (!puzzleStartTime) {
                    puzzleStartTime = new Date(puzzleAttempts[currentPuzzleDateFormatted].startTime || Date.now()); // Use saved start time or current time
                }

                if (!puzzleAttempts[currentPuzzleDateFormatted].startTime) { // If not saved, save it now
                    puzzleAttempts[currentPuzzleDateFormatted].startTime = puzzleStartTime.toISOString();
                    saveGameState();
                }

                timerInterval = setInterval(() => {
                    const currentTime = new Date();
                    const elapsed = Math.floor((currentTime - puzzleStartTime) / 1000);
                    timerDisplay.textContent = `Elapsed time: ${formatTime(elapsed)}`;
                }, 1000);
            };

            const stopTimer = () => {
                clearInterval(timerInterval);
            };

            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            };

            // Event listener for check answer button
            checkAnswerBtn.addEventListener('click', () => {
                const activeQuestionDiv = document.querySelector('.question.active');
                if (!activeQuestionDiv) return;

                const puzzleIdx = questionsData.findIndex(q => q.id === activeQuestionDiv.id); // Get 0-indexed puzzle index
                const questionData = questionsData[puzzleIdx];

                let allCorrect = true;
                let score = 0;
                let totalBlanks = 0;
                const currentPuzzleDate = selectedCalendarDate || new Date(CHALLENGE_START_DATE.getTime() + puzzleIdx * (1000 * 60 * 60 * 24));
                const currentPuzzleDateFormatted = formatDate(currentPuzzleDate);

                if (!puzzleAttempts[currentPuzzleDateFormatted]) {
                    puzzleAttempts[currentPuzzleDateFormatted] = { answers: {}, results: {}, hintsData: {}, score: '0/0', completed: false, timeTaken: 0, startTime: null };
                }
                const currentPuzzleData = puzzleAttempts[currentPuzzleDateFormatted];

                questionData.blanks.forEach(blank => {
                    const input = document.getElementById(blank.id);
                    if (!input) return; // Should not happen if HTML generated correctly

                    const userAnswer = input.value.trim().toLowerCase();
                    const isCorrect = blank.correct.includes(userAnswer);

                    totalBlanks++;

                    currentPuzzleData.answers[input.id] = input.value.trim(); // Save user's input
                    currentPuzzleData.results[input.id] = isCorrect; // Save result

                    if (isCorrect) {
                        input.classList.remove('incorrect');
                        input.classList.add('correct');
                        score++;
                    } else {
                        input.classList.remove('correct');
                        input.classList.add('incorrect');
                        allCorrect = false;
                    }
                });

                currentPuzzleData.score = `${score}/${totalBlanks}`;

                const hintsUsedCount = (currentPuzzleData.hintsData[puzzleIdx + 1] && puzzleData.hintsData[puzzleIdx + 1].nextIndexToReveal) || 0;


                if (allCorrect) {
                    stopTimer();
                    const elapsedSinceStart = (new Date() - new Date(currentPuzzleData.startTime));
                    const elapsedTimeSeconds = Math.floor(elapsedSinceStart / 1000);
                    currentPuzzleData.timeTaken = elapsedTimeSeconds;
                    currentPuzzleData.completed = true;

                    dailyResult.innerHTML = `<strong>Correct: ${score}/${totalBlanks}</strong>, Hints: ${hintsUsedCount}, <strong>Time used: ${formatTime(elapsedTimeSeconds)}</strong>`;
                    copyResultButton.style.display = 'inline-block';
                    
                    disableInputsAndButtons(true);
                } else {
                    dailyResult.innerHTML = `<strong>Correct: ${score}/${totalBlanks}</strong>, Hints: ${hintsUsedCount}, <strong>Time used: ${formatTime(Math.floor((new Date() - new Date(currentPuzzleData.startTime)) / 1000))}</strong>`;
                    copyResultButton.style.display = 'none';
                }
                saveGameState(); // Save state after checking answers
                renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
            });

            // Helper to disable inputs and buttons
            const disableInputsAndButtons = (disable) => {
                const activeQuestion = document.querySelector('.question.active');
                if (!activeQuestion) return;

                const inputs = activeQuestion.querySelectorAll('input[type="text"]');
                inputs.forEach(input => input.disabled = disable);
                checkAnswerBtn.disabled = disable;
            };

            copyResultButton.addEventListener('click', () => {
                const currentPuzzleDate = selectedCalendarDate || TODAY;
                const currentPuzzleDateFormatted = formatDate(currentPuzzleDate);
                const puzzleData = puzzleAttempts[currentPuzzleDateFormatted];

                if (puzzleData && puzzleData.completed) {
                    const activeQuestionDiv = document.querySelector('.question.active');
                    const puzzleIdx = questionsData.findIndex(q => q.id === activeQuestionDiv.id);
                    const hintsUsedCount = (puzzleData.hintsData[puzzleIdx + 1] && puzzleData.hintsData[puzzleIdx + 1].nextIndexToReveal) || 0;

                    let resultText = '';
                    resultText += `REVIDERS DAILY WORD CHALLENGE\n`;
                    resultText += `PUZZLE ${puzzleIdx + 1}: CORRECT: ${puzzleData.score}, HINTS: ${hintsUsedCount}, TIME USED: ${formatTime(puzzleData.timeTaken)}\n`;
                    resultText += `-------------------------------------------\n`;

                    const inputs = activeQuestionDiv.querySelectorAll('input[type="text"]');
                    inputs.forEach(input => {
                        const answerId = input.id;
                        const isCorrect = puzzleData.results[answerId];
                        resultText += `[${isCorrect ? '✅' : '❌'}] ${input.value.toUpperCase()}\n`;
                    });

                    copyResultDisplay.value = resultText;
                    copyResultDisplay.style.display = 'block';
                    copyResultDisplay.classList.add('show');
                    document.execCommand('copy');

                    setTimeout(() => {
                        copyResultDisplay.classList.remove('show');
                        setTimeout(() => { copyResultDisplay.style.display = 'none'; }, 300);
                    }, 2000);
                }
            });

            // Calendar logic
            let currentMonth = new Date();
            currentMonth.setDate(1); // Set to the first day of the month

            const renderCalendar = (year, month) => {
                const calendarGrid = document.querySelector('.calendar-grid');
                calendarGrid.innerHTML = ''; // Clear all existing children to prevent duplication

                currentMonthYear.textContent = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDay = firstDayOfMonth.getDay();

                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayNames.forEach(day => {
                    const header = document.createElement('div');
                    header.classList.add('calendar-day-name');
                    header.textContent = day;
                    calendarGrid.appendChild(header);
                });

                for (let i = 0; i < startDay; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.classList.add('calendar-day-cell', 'empty');
                    calendarGrid.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('calendar-day-cell');
                    dayCell.textContent = day;

                    const cellDate = new Date(year, month, day);
                    cellDate.setHours(0,0,0,0); // Normalize cell date to midnight
                    const cellDateFormatted = formatDate(cellDate);

                    // Determine puzzle index for this cellDate
                    const puzzleIdxForCell = getDayDifference(CHALLENGE_START_DATE, cellDate);
                    
                    if (cellDateFormatted === formatDate(TODAY)) {
                        dayCell.classList.add('today');
                    }
                    if (formatDate(cellDate) === formatDate(selectedCalendarDate)) { // Compare formatted strings
                        dayCell.classList.add('selected-date');
                    }

                    // Condition to grey out dates before CHALLENGE_START_DATE
                    if (cellDate < CHALLENGE_START_DATE) {
                        dayCell.classList.add('unavailable-past');
                    }
                    
                    // Condition to grey out dates beyond available questions
                    if (puzzleIdxForCell >= questionsData.length || cellDate > LAST_QUESTION_DATE) {
                        dayCell.classList.add('no-question');
                    }


                    const puzzleData = puzzleAttempts[cellDateFormatted];
                    if (puzzleData) {
                        if (puzzleData.completed) {
                            dayCell.classList.add('solved');
                        } else if (puzzleData.startTime) {
                            dayCell.classList.add('unsolved');
                        }
                    }

                    dayCell.addEventListener('click', () => {
                        if (!dayCell.classList.contains('empty') && !dayCell.classList.contains('no-question') && !dayCell.classList.contains('unavailable-past')) {
                            const prevSelected = document.querySelector('.calendar-day-cell.selected-date');
                            if (prevSelected) {
                                prevSelected.classList.remove('selected-date');
                            }
                            dayCell.classList.add('selected-date');
                            selectedCalendarDate = cellDate;
                            currentPuzzleIndex = puzzleIdxForCell; // Set current puzzle index
                            renderCurrentQuestion(currentPuzzleIndex); // Render the selected question
                            calendarContainer.classList.remove('is-visible'); // Hide calendar
                            landingPage.style.display = 'none'; // Ensure landing is hidden
                            gameContent.style.display = 'flex'; // Show game content
                            // Timer will be started/resumed by renderCurrentQuestion
                        }
                    });

                    calendarGrid.appendChild(dayCell);
                }
            };

            // Event Listeners for new Landing Page Buttons
            landingStartPuzzleBtn.addEventListener('click', () => {
                landingPage.style.display = 'none';
                gameContent.style.display = 'flex'; // Show game content
                currentPuzzleIndex = todayPuzzleIndex; // Ensure today's puzzle is selected
                selectedCalendarDate = TODAY; // Set selected date to today for accurate tracking
                renderCurrentQuestion(currentPuzzleIndex); // Render today's puzzle
            });


            landingCalendarBtn.addEventListener('click', () => {
                console.log('Calendar button (landing page) clicked!'); // Debugging log
                openedFromPage = 'landingPage'; // Set origin
                landingPage.style.display = 'none'; // Hide landing page
                calendarContainer.classList.add('is-visible'); // Use class to show
                currentMonth = new Date(selectedCalendarDate || TODAY); // Start calendar on the currently selected date's month
                currentMonth.setDate(1); // Set to the first day of the month
                renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
            });

            // Instructions button on the Game Content (now links to landing page instructions)
            instructionsButton.addEventListener('click', () => { 
                gameContent.style.display = 'none'; // Hide game content
                landingPage.style.display = 'flex'; // Show landing page
                // Scroll to instructions section on landing page
                const instructionsSection = document.getElementById('game-instructions');
                if (instructionsSection) {
                    instructionsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                stopTimer(); // Stop timer if game is active
            });


            // Calendar button on Game Content (now directly opens calendar)
            calendarButton.addEventListener('click', () => {
                console.log('Calendar button (game page) clicked!'); // Debugging log
                openedFromPage = 'gameContent'; // Set origin
                gameContent.style.display = 'none'; // Hide game content
                calendarContainer.classList.add('is-visible'); // Show calendar modal
                currentMonth = new Date(selectedCalendarDate || TODAY); // Start calendar on the currently selected date's month
                currentMonth.setDate(1); // Set to the first day of the month
                renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
            });

            // Update existing Close button handlers for modals to return to correct page
            closeCalendarBtn.addEventListener('click', () => {
                calendarContainer.classList.remove('is-visible'); // Use class to hide
                if (openedFromPage === 'landingPage') {
                    landingPage.style.display = 'flex'; // Return to landing page
                } else if (openedFromPage === 'gameContent') {
                    gameContent.style.display = 'flex'; // Return to game content
                }
            });

            prevMonthBtn.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar(currentMonth.getFullYear(), currentMonth.getMonth());
            });


            // Initial page load: Only show landing page
            landingPage.style.display = 'flex';
            gameContent.style.display = 'none';
            calendarContainer.classList.remove('is-visible'); // Ensure it's hidden initially

            loadGameState(); // Load game state at startup
        });
    </script>

</body>
</html>
